name: 'Cache Go dependencies and test results'
params:
  matrix:
    required: true
    default: ${{ toJSON(matrix) }}
runs:
  using: "composite"
  steps:
    - uses: actions/github-script@v6
      id: serialize-matrix
      with:
        script: return "1${{inputs.matrix}}1"
        result-encoding: string
    - uses: actions/cache@v2
      with:
        path: ~/go/pkg/mod
        key: ${{ github.workflow }}-${{ github.job }}-${{ runner.os }}-${{ steps.serialize-matrix.outputs.result }}-go-mod-${{ hashFiles('**/go.sum') }}
        restore-keys: ${{ github.workflow }}-${{ github.job }}-${{ runner.os }}-${{ steps.serialize-matrix.outputs.result }}-go-mod
    - uses: actions/cache@v2
      if: ${{ github.ref != 'master' }}
      with:
        path: ~/.cache/go-build
        key: ${{ github.workflow }}-${{ github.job }}-${{ runner.os }}-${{ steps.serialize-matrix.outputs.result }}-go-build-${{ github.ref }}-${{ hashFiles('**', '!.git') }}
        restore-keys: |
          ${{ github.workflow }}-${{ github.job }}-${{ runner.os }}-${{ steps.serialize-matrix.outputs.result }}-go-build-${{ github.ref }}
          ${{ github.workflow }}-${{ github.job }}-${{ runner.os }}-${{ steps.serialize-matrix.outputs.result }}-go-build
